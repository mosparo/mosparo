{% extends 'project_related/project_related_base.html.twig' %}

{% trans_default_domain 'mosparo' %}

{% block documentTitle %}{{ 'rulePackage.deleteProcess.title'|trans({ '%rulePackageName%': processingJob.rulePackage.name}) }} - {{ parent() }}{% endblock %}
{% block pagePreTitle %}{% endblock %}
{% block pageTitle %}{% endblock %}

{% block pageBody %}
    <div class="container-narrow pb-4">
        <div class="row">
            <div class="col text-center">
                <img src="{{ asset('build/images/icons/rule-package.svg')|add_path_prefix }}" class="mb-5 illustration-detail" alt="" />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="card card-md">
                    <div class="card-body">
                        <h2 class="card-title text-center mb-4">{{ 'rulePackage.delete.process.title'|trans({ '%rulePackageName%': processingJob.rulePackage.name}) }}</h2>

                        <p>{{ 'rulePackage.delete.process.intro'|trans }}</p>

                        <div class="alert alert-info" id="alert-do-not-leave">
                            {{ 'rulePackage.delete.process.alert.doNotLeave'|trans }}
                        </div>

                        <div class="progress mb-1">
                            <div class="progress-bar import-progress-bar"></div>
                        </div>
                        <div class="text-center mb-3">
                            <span class="import-progress-value">0</span>%
                        </div>

                        <div class="alert alert-success d-none" id="alert-progress-success">
                            {{ 'rulePackage.delete.process.alert.processCompleted'|trans }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12 col-md-auto mt-2 mt-md-0">
                <a href="{{ path('rule_package_list', { '_projectId': activeProject.id }) }}" class="btn btn-outline-secondary w-100 d-none" tabindex="1000" id="btn-back-to-list">
                    <i class="ti ti-chevron-left"></i>
                    {{ 'rulePackage.backToList'|trans }}
                </a>
            </div>
            <div class="col-12 col-md-auto ms-auto order-first order-md-last"></div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {% cspscript %}
        <script>
            function processJob()
            {
                $.post('{{ path('rule_package_delete_process_execute', {'_projectId': activeProject.id, 'id': processingJob.id}) }}', {  }, function (responseData) {
                    let progressBarEl = $('.import-progress-bar');
                    let progressValueEl = $('.import-progress-value');

                    if (!progressBarEl.hasClass('bg-cyan')) {
                        progressBarEl.addClass('bg-cyan');
                    }

                    progress = responseData.cleanupProgress;

                    if (responseData.completed) {
                        progress = 100;
                    }

                    if (progress) {
                        progressBarEl.css('width', progress + '%');
                        progressValueEl.text(progress);

                        if (progress === 100) {
                            if (responseData.result === 0) {
                                progressBarEl.removeClass('bg-cyan').addClass('bg-green');

                                $('#alert-do-not-leave').addClass('d-none');
                                $('#alert-progress-success').removeClass('d-none');
                                $('#btn-back-to-list').removeClass('d-none');
                            }
                        }
                    }

                    if (responseData.error) {
                        progressBarEl.addClass('bg-red');
                    }

                    if (responseData.completed || responseData.error) {
                        return;
                    }

                    setTimeout(processJob, 1);
                }, 'json');
            }

            $(document).ready(function () {
                processJob();
            });
        </script>
    {% endcspscript %}
{% endblock %}